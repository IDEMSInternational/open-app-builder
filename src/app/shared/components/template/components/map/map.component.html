<div class="map-container">
  <div class="map-and-legend-container">
    <div id="mapElement" #mapElement class="map"></div>
    <div class="legend">
      @for (layerGroup of mapLayerGroupsSorted; track $index) {
        @for (mapLayer of layerGroup.layers; track $index) {
          @if (mapLayer.getVisible() && mapLayer.get("gradientFill")) {
            <div class="legend-item">
              <div class="title">
                {{ mapLayer.get("scaleTitle") }}
              </div>
              <div class="scale-container">
                @if (mapLayer.get("scaleSlider")) {
                  <ngx-slider
                    [value]="mapLayer.get('scaleMin')"
                    [highValue]="mapLayer.get('scaleMax')"
                    [options]="{
                      floor: mapLayer.get('scaleMin'),
                      ceil: mapLayer.get('scaleMax'),
                      step: mapLayer.get('scaleIncrement') || mapLayer.get('scaleMax') / 10,
                      showTicks: !!mapLayer.get('scaleIncrement'),
                      showTicksValues: !!mapLayer.get('scaleIncrement')
                    }"
                    (userChangeEnd)="handleSliderChange($event, mapLayer)"
                    [ngStyle]="{ '--bar-background': mapLayer.get('gradientFill') }"
                  ></ngx-slider>
                } @else {
                  <div
                    class="colour-scale"
                    [ngStyle]="{ 'background-image': mapLayer.get('gradientFill') }"
                  ></div>
                  <div class="scale-labels">
                    <div class="scale-label max">
                      {{ mapLayer.get("scaleMax") }}
                    </div>
                    <div class="scale-label min">
                      {{ mapLayer.get("scaleMin") }}
                    </div>
                  </div>
                }
              </div>
            </div>
          }
        }
      }
    </div>
  </div>
  <div class="map-controls">
    @for (layerGroup of mapLayerGroupsSorted; track $index) {
      @if (!layerGroup.controls_style || layerGroup.controls_style === "dropdown") {
        @if (layerGroup.layers.length > 0) {
          <div class="map-control-container">
            <p>{{ (layerGroup.name || "Visible layers") + ":" }}</p>
            <ion-select
              interface="modal"
              fill="outline"
              placeholder="Select map layers to view"
              [multiple]="!layerGroup.single_selection"
              (ionChange)="handleDropdownChange($event, layerGroup.id)"
              [value]="getVisibleLayerNames(layerGroup.id)"
            >
              @for (mapLayer of layerGroup.layers; track $index) {
                <ion-select-option [value]="mapLayer.get('name')">
                  <ion-item>
                    <ion-label>
                      {{
                        mapLayer.get("name") +
                          (mapLayer.get("description") ? " â€“ " + mapLayer.get("description") : "")
                      }}
                    </ion-label>
                  </ion-item>
                </ion-select-option>
              }
            </ion-select>
          </div>
        }
      } @else if (params.controlsStyle === "list") {
        <ion-list>
          @for (mapLayer of layerGroup.layers; track $index) {
            <ion-item>
              <ion-label>
                <ion-toggle
                  [checked]="mapLayer.getVisible()"
                  (ionChange)="handleToggleChange($event, mapLayer)"
                >
                  {{ mapLayer.get("name") }}
                </ion-toggle>
                @if (mapLayer.get("description")) {
                  <p>
                    {{ mapLayer.get("description") }}
                  </p>
                }
              </ion-label>
            </ion-item>
          }
        </ion-list>
      }
    }
  </div>
</div>
